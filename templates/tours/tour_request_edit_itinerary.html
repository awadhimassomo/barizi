{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Itinerary - {{ tour_request.client_name }}{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <a href="{% url 'tour_request_detail' tour_request.pk %}" class="text-primary hover:underline mb-2 inline-block">
                <i class="fas fa-arrow-left mr-2"></i>Back to Details
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Edit Itinerary</h1>
            <p class="text-gray-500">{{ tour_request.client_name }} â€¢ {{ tour_request.start_date }} to {{ tour_request.end_date }}</p>
        </div>
        <div class="flex gap-2">
            <form method="POST" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_day">
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Day
                </button>
            </form>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" id="itineraryForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_itinerary">

        <!-- Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-file-alt text-primary mr-2"></i>Tour Summary
            </h2>
            <textarea name="summary" rows="3" 
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                      placeholder="Brief tour summary...">{{ itinerary.summary }}</textarea>
        </div>

        <!-- Days -->
        {% for day in days %}
        <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden" id="day_{{ forloop.counter0 }}">
            <!-- Day Header -->
            <div class="bg-black text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">
                        {{ day.day }}
                    </span>
                    <input type="text" name="day_{{ forloop.counter0 }}_title" value="{{ day.title }}"
                           class="bg-transparent border-b border-white/30 text-white text-lg font-semibold focus:border-primary outline-none px-2 py-1 w-64">
                </div>
                <form method="POST" class="inline" onsubmit="return confirm('Delete this day?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_day">
                    <input type="hidden" name="day_index" value="{{ forloop.counter0 }}">
                    <button type="submit" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>

            <div class="p-6">
                <!-- Day Description -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Day Description</label>
                    <textarea name="day_{{ forloop.counter0 }}_description" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">{{ day.description }}</textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Activities Section -->
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-hiking text-primary mr-2"></i>Activities
                        </h3>
                        <div class="space-y-3" id="activities_{{ forloop.counter0 }}">
                            {% for activity in day.activities %}
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <input type="text" name="day_{{ forloop.parentloop.counter0 }}_activity_{{ forloop.counter0 }}_time" 
                                           value="{{ activity.time }}" placeholder="Time (e.g., 6:00 AM)"
                                           class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                    <input type="text" name="day_{{ forloop.parentloop.counter0 }}_activity_{{ forloop.counter0 }}_duration" 
                                           value="{{ activity.duration }}" placeholder="Duration"
                                           class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                </div>
                                <input type="text" name="day_{{ forloop.parentloop.counter0 }}_activity_{{ forloop.counter0 }}_name" 
                                       value="{{ activity.name }}" placeholder="Activity name"
                                       class="w-full px-3 py-2 border border-gray-300 rounded text-sm mb-2 focus:ring-primary focus:border-primary">
                                <textarea name="day_{{ forloop.parentloop.counter0 }}_activity_{{ forloop.counter0 }}_description" 
                                          rows="2" placeholder="Description"
                                          class="w-full px-3 py-2 border border-gray-300 rounded text-sm mb-2 focus:ring-primary focus:border-primary">{{ activity.description }}</textarea>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">Cost: $</span>
                                    <input type="number" name="day_{{ forloop.parentloop.counter0 }}_activity_{{ forloop.counter0 }}_cost" 
                                           value="{{ activity.cost }}" step="0.01" min="0"
                                           class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-gray-500 text-sm">No activities yet</div>
                            {% endfor %}
                            <input type="hidden" name="day_{{ forloop.counter0 }}_activity_count" value="{{ day.activities|length }}">
                        </div>
                        <button type="button" onclick="addActivity({{ forloop.counter0 }})" 
                                class="mt-3 text-primary hover:text-orange-600 text-sm font-medium">
                            <i class="fas fa-plus mr-1"></i>Add Activity
                        </button>
                    </div>

                    <!-- Accommodation & Transport -->
                    <div class="space-y-4">
                        <!-- Accommodation -->
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-bed text-primary mr-2"></i>Accommodation
                            </h3>
                            <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                                <input type="text" name="day_{{ forloop.counter0 }}_hotel_name" 
                                       value="{{ day.accommodation.name }}" placeholder="Hotel name"
                                       class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" name="day_{{ forloop.counter0 }}_hotel_type" 
                                           value="{{ day.accommodation.type }}" placeholder="Type (e.g., Lodge)"
                                           class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                    <input type="text" name="day_{{ forloop.counter0 }}_meal_plan" 
                                           value="{{ day.accommodation.meal_plan }}" placeholder="Meal plan (FB, HB)"
                                           class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">Price/night: $</span>
                                    <input type="number" name="day_{{ forloop.counter0 }}_hotel_price" 
                                           value="{{ day.accommodation.price_per_night }}" step="0.01" min="0"
                                           class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <!-- Transport -->
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-car text-primary mr-2"></i>Transport
                            </h3>
                            <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                                <input type="text" name="day_{{ forloop.counter0 }}_transport_type" 
                                       value="{{ day.transport.type }}" placeholder="Vehicle type"
                                       class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                <input type="text" name="day_{{ forloop.counter0 }}_transport_details" 
                                       value="{{ day.transport.details }}" placeholder="Details (route, distance)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">Cost: $</span>
                                    <input type="number" name="day_{{ forloop.counter0 }}_transport_cost" 
                                           value="{{ day.transport.cost }}" step="0.01" min="0"
                                           class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <!-- Meals -->
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-utensils text-primary mr-2"></i>Meals Included
                            </h3>
                            <div class="flex gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" name="day_{{ forloop.counter0 }}_meals" value="Breakfast"
                                           {% if 'Breakfast' in day.meals_included %}checked{% endif %}
                                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <span class="ml-2 text-sm">Breakfast</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="day_{{ forloop.counter0 }}_meals" value="Lunch"
                                           {% if 'Lunch' in day.meals_included %}checked{% endif %}
                                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <span class="ml-2 text-sm">Lunch</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="day_{{ forloop.counter0 }}_meals" value="Dinner"
                                           {% if 'Dinner' in day.meals_included %}checked{% endif %}
                                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <span class="ml-2 text-sm">Dinner</span>
                                </label>
                            </div>
                        </div>

                        <!-- Tips -->
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-lightbulb text-primary mr-2"></i>Day Tips
                            </h3>
                            <textarea name="day_{{ forloop.counter0 }}_tips" rows="2" placeholder="Tips for this day..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">{{ day.tips }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Cost Breakdown -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-calculator text-primary mr-2"></i>Cost Breakdown (Per Person)
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Accommodation</label>
                    <div class="flex items-center">
                        <span class="text-gray-500 mr-1">$</span>
                        <input type="number" name="accommodation_total" value="{{ cost_breakdown.accommodation_total }}" 
                               step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Activities</label>
                    <div class="flex items-center">
                        <span class="text-gray-500 mr-1">$</span>
                        <input type="number" name="activities_total" value="{{ cost_breakdown.activities_total }}" 
                               step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Transport</label>
                    <div class="flex items-center">
                        <span class="text-gray-500 mr-1">$</span>
                        <input type="number" name="transport_total" value="{{ cost_breakdown.transport_total }}" 
                               step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Park Fees</label>
                    <div class="flex items-center">
                        <span class="text-gray-500 mr-1">$</span>
                        <input type="number" name="park_fees_total" value="{{ cost_breakdown.park_fees_total }}" 
                               step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t flex items-center justify-between">
                <div class="text-gray-600">
                    <span class="font-medium">Markup:</span> {{ tour_request.markup_percentage }}%
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Current Total (per person)</p>
                    <p class="text-2xl font-bold text-primary">${{ cost_breakdown.total_per_person|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end gap-4">
            <a href="{% url 'tour_request_detail' tour_request.pk %}" 
               class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="submit" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-orange-600 transition-colors">
                <i class="fas fa-save mr-2"></i>Save Changes
            </button>
        </div>
    </form>
</div>

<script>
function addActivity(dayIndex) {
    const container = document.getElementById('activities_' + dayIndex);
    const countInput = container.querySelector('input[name="day_' + dayIndex + '_activity_count"]');
    const currentCount = parseInt(countInput.value) || 0;
    
    const activityHtml = `
        <div class="bg-gray-50 rounded-lg p-3">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" name="day_${dayIndex}_activity_${currentCount}_time" 
                       placeholder="Time (e.g., 6:00 AM)"
                       class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                <input type="text" name="day_${dayIndex}_activity_${currentCount}_duration" 
                       placeholder="Duration"
                       class="px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
            </div>
            <input type="text" name="day_${dayIndex}_activity_${currentCount}_name" 
                   placeholder="Activity name"
                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm mb-2 focus:ring-primary focus:border-primary">
            <textarea name="day_${dayIndex}_activity_${currentCount}_description" 
                      rows="2" placeholder="Description"
                      class="w-full px-3 py-2 border border-gray-300 rounded text-sm mb-2 focus:ring-primary focus:border-primary"></textarea>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">Cost: $</span>
                <input type="number" name="day_${dayIndex}_activity_${currentCount}_cost" 
                       value="0" step="0.01" min="0"
                       class="w-24 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
            </div>
        </div>
    `;
    
    // Insert before the count input
    countInput.insertAdjacentHTML('beforebegin', activityHtml);
    countInput.value = currentCount + 1;
}
</script>
{% endblock %}
